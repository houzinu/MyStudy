# 组播

#### 单播方式部署点到多点应用

* 单播方式存在的问题

  * 重复流量过多

  * 消耗设备和链路带宽资源

  * 难以保证传输质量

#### 广播方式部署点到多点应用

* 广播方式存在的问题
  * 地域范围限制
  * 安全性无法保障
  * 有偿性无法保障

> 组播地址永远是<font color = red>224.0.0.0~239.255.255.255</font>,只作为目标地址。

组播的定义：一点出发，多点接收。

在发送者和接受者之间实现点对多点的网络连接；给多个接收者传输相同的数据，只需要复制一份的相同数据；提高了数据传输效率也减少了骨干网络出现拥塞的可能性。

###### 组播的优势

* 提高效率
* 优化性能
* 分布式应用

###### 组播的劣势

组播的应用大多基于UDP，从而导致

* 尽力而为
* 报文重复
* 报文失序
* 缺少拥塞避免机制

|                    模型                     |                             备注                             |
| :-----------------------------------------: | :----------------------------------------------------------: |
|    ASM(Any-Source multicast,任意源组播)     | 要求组播地址必须整个组播网中唯一，即同一时刻只能被一种组播应用使用 |
| SSM（Source-Specific Multicast,源指定组播） |     组播地址不再要求全网唯一，只需要每个组播源上保持唯一     |

###### 永久组播地址：<font color = black>为路由协议预留的组播地址。</font>

###### 临时组播地址：<font color = black>为用户组播组临时分配的IP地址，组成员的数量一旦为0即取消。</font>

###### 用户可用的ASM临时组播地址组：

1. ==224.0.1.0~231.255.255.255==
2. ==233.0.0.0~238.255.255.255==

###### 用户可用的SSM临时组播地址组：

==232.0.0.0~232.255.255.255==

[*最高权限组织对路由协议预留的组播地址分配](https://www.iana.org/assignments/multicast-addresses/multicast-addresses.xhtml)

组播相关的路由协议：<font color = green>IGMP和PIM。</font>

![image-20220716000713080](C:\Users\yangc\AppData\Roaming\Typora\typora-user-images\image-20220716000713080.png)

PIM:协议无关组播——有两种模式

* DM(密集模式，Dense Mode)：当接收者分布较为密集时适用；

* SM(稀疏模式, Sparse Mode)：当接收接分布较为稀疏时适用。

  ==PIM必须和单播路由协议协同工作==

  ### 组播要解决的三大模块

  1. 接收者和最近的一台组播路由器（最后一跳路由器）；
  2. 路由器和路由器之间如何选址；
  3. 源组播服务器和最近的一台组播路由器（第一跳路由器）；

<font color = purple>接收端如何接收组播数据</font>

> 接收者与路由器之间需要交换哪些信息？

-->接收者需声明自己要接收哪个组的数据；

​	路由器需了解哪些组播存在接收者。

> IGMP协议运行在组播路由器和主机侧之间的接口，路由器之间不需要运行。

* 主机侧：通过IGMP向路由器通告组成员关系
* 路由器侧：通过IGMP维护组成员关系。

#### IGMP版本

* IGMPv1 ：定义了基本的组成员查询和报告过程。
* IGMPv2 ：在IGMPv1的基础上添加了<font size = 7;font color = red>查询器选举</font>和<font size = 7;font color = red> 离开组</font>机制。
* IGMPv3 ： 成员可以指定接收或不接收某些组播源的报文。

###### 查询器的选举：<font color = black>IP地址最小的获胜。</font>

组播借助PIM（协议无关组播）来选举DR，只有DR负责发送组播查询报文。

1. 组播路由器每60s发送一次查询报文，目的地址为224.1.1.0，组地址为0.0.0.0。
2. 组成员在收到查询报文后，开启计时器，计时器被设置为0~10s，在计时器超时后，向查询路由器发送成员关系报告报文，这个报文的目的IP地址是想要加入的组播组的IP地址。
3. 同一个组播组下的所有成员，在收到相同的关系查询报文时，默认只有计时器率先超时的主机会发送成员关系报告报文给关系查询路由器，其他的主机会抑制自己，不发送关系报告报文。
4. IGMPv1下，有成员离开组播组时，不会发送任何报文告知查询器，而是“默默离开”，查询器发送关系查询报文后，等待130s<font color = green>(2*默认关系查询报文发送时间+10s的计时器时间)</font>后，将认为该组播组已经不存在成员，不再发送组播地址为该组的流量。

##### IGMPv2

在IGMPv2中，一共有四种报文。

1. 成员关系查询报文
   * 常规查询：目的IP地址为224.0.0.1，查询的是所有组播组，也叫普遍查询。
   * 特定组查询：IGMPv2的主机在离开所加入的组播组时，会发送一个离组报文来宣告自己离开。当查询器收到这个离组报文后，会发送特定的组的报文，来确认该组中是否还有其他成员存在。
2. 成员关系报告报文
3. 离组报文；在IGMPv1的基础上加入了离组报文，目的IP地址为224.0.0.2.
4. 版本1成员关系报告报文：用于兼容IGMPv1。



##### #类型值有4种

1. 成员关系查询报文 0x11；
2. v1的成员关系报告报文 0x12;
3. v2的成员关系报告报文 0x16;
4. 离组报文 0x17。

成员关系抑制报告机制：v2和v1有一点细微的差异；IMGPv2增加了最大响应时间，这个值可以调节。取值范围为0~最大响应时间之间。

在IGMPv2中，当有成员离开组播组时，会向查询器发送离组报文，告知自己离开。查询器收到离组报文后，会发送查询报文（特定组播组）来查看组播组中是否还有其他成员存在，如果有成员响应了，则继续维护成员关系，如果没有，查询器会以1s为间隔，发送两次，如果没有了响应，在经过一段时间后，将不再发送该组播组相关的流量。

* IGMPv2的查询器选举：该网段中IP地址最小的成为查询器，具备抢占机制。非查询器会启动一个==其他查询器存活计时，缺省为125s==，在长时间接收不到查询器发送的查询报文而导致计时器超时，费查询器就会认为当前查询器已发送故障，出发新一轮的查询器选举。



IGMPv3服务与SSM模型，同时取消了组成员报告抑制机制。

nihao,wejwiqerfhwqlierfujwipqjrwqirfjqwirjfwqirfjqwirfjqwi

wqioetfwqhjeirtohjwairfujwierfu

qwuiofhwoirhqwihrqwuihrweuirhjwi
