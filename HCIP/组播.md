# 组播

#### 单播方式部署点到多点应用

* 单播方式存在的问题

  * 重复流量过多

  * 消耗设备和链路带宽资源

  * 难以保证传输质量

#### 广播方式部署点到多点应用

* 广播方式存在的问题
  * 地域范围限制
  * 安全性无法保障
  * 有偿性无法保障

> 组播地址永远是<font color = red>224.0.0.0~239.255.255.255</font>,只作为目标地址。

> 组播MAC和单播MAC地址的区别：第八个比特为1的是组播，为0的是单播。

组播的定义：一点出发，多点接收。

在发送者和接受者之间实现点对多点的网络连接；给多个接收者传输相同的数据，只需要复制一份的相同数据；提高了数据传输效率也减少了骨干网络出现拥塞的可能性。

###### 组播的优势

* 提高效率
* 优化性能
* 分布式应用

###### 组播的劣势

组播的应用大多基于UDP，从而导致

* 尽力而为
* 报文重复
* 报文失序
* 缺少拥塞避免机制

|                    模型                     |                             备注                             |
| :-----------------------------------------: | :----------------------------------------------------------: |
|    ASM(Any-Source multicast,任意源组播)     | 要求组播地址必须整个组播网中唯一，即同一时刻只能被一种组播应用使用 |
| SSM（Source-Specific Multicast,源指定组播） |     组播地址不再要求全网唯一，只需要每个组播源上保持唯一     |

###### 永久组播地址：<font color = black>为路由协议预留的组播地址。</font>

###### 临时组播地址：<font color = black>为用户组播组临时分配的IP地址，组成员的数量一旦为0即取消。</font>

###### 用户可用的ASM临时组播地址组：

1. ==224.0.1.0~231.255.255.255==
2. ==233.0.0.0~238.255.255.255==
2. 239.0.0.0~239.255.255.255(本地私有)

###### 用户可用的SSM临时组播地址组：

==232.0.0.0~232.255.255.255==

[*最高权限组织对路由协议预留的组播地址分配](https://www.iana.org/assignments/multicast-addresses/multicast-addresses.xhtml)

组播地址的双重作用：

1. 表示某一个组播应用/组播业务
2. 代表了接收这种组播业务的所有主机。

==组播IP地址的前4位是固定的1110==

组播IP报文的DIP由组播业务/组播应用实现确定好了

​					   SIP就是发送该组播报文的主机的IP

组播mac怎么确定？

==01-00-5e==是OUI给组播发配的MAC前25位固定地址，后23位和组播IP地址映射而来。25位保持为0.

例如：239.1.1.10-------MAC?

​	01-00-5e-==0==0000001-00000001-00001010

​	01-00-5e-01-01-0A

<font color = blue>组播IP和组播MAC地址映射的问题？</font>

1. 组播IP有5个bit在组播MAC中被丢弃，导致2^5^=32个IP地址共享一个组播MAC的问题。
2. 如何避免？在规划的时候，保证后23位不重叠即可。



#### ASM和SSM

ASM:任意源组播地址
如果客户端程序只能选择加入的组地址，而无法选择组播源的地址，则部署ASM模型。
239.1.1.10

239.1.1.11

239.1.1.12
特点:仅通过组地址来区分不同的组播业务，即不同的组播业务得分配不同的组播地址，组播地址利用率不高。客户端无需维护组播源的信息，客户端开发难度低。

SSM:指定源组播地址
如果客户端程序即可以选择加入的组地址，也能选择加入的源地址，则部署SSM模型
特点:不同的源可以使用相同的组地址提供不同的组播服务。提供组播地址利用率，但是客户端需要事先维护所有组播源和组的对应关系。
1.1.1.1	239.1.1.10	

2.2.2.2	 239.1.1.10
3.3.3.3	 239.1.1.10
1.1.1.1	 239.1111

组播相关的路由协议：<font color = green>IGMP和PIM。</font>

![image-20220716000713080](C:\Users\yangc\AppData\Roaming\Typora\typora-user-images\image-20220716000713080.png)

* 

  ==PIM必须和单播路由协议协同工作==

  ### 组播要解决的三大模块

  1. 接收者和最近的一台组播路由器（最后一跳路由器）；
  2. 路由器和路由器之间如何选址；
  3. 源组播服务器和最近的一台组播路由器（第一跳路由器）；

<font color = purple>接收端如何接收组播数据</font>

> 接收者与路由器之间需要交换哪些信息？

-->接收者需声明自己要接收哪个组的数据；

​	路由器需了解哪些组播存在接收者。

> IGMP协议运行在组播路由器和主机侧之间的接口，路由器之间不需要运行。

* 主机侧：通过IGMP向路由器通告组成员关系
* 路由器侧：通过IGMP维护组成员关系。

#### IGMP协议

* IGMPv1 ：定义了基本的^1^组成员查询和^2^报告过程，还有^3^报告抑制机制
* IGMPv2 ：在IGMPv1的基础上添加了<font size = 7;font color = red>查询器选举</font>和<font size = 7;font color = red> 离开组</font>机制。
* IGMPv3 ： 成员可以指定接收或不接收某些组播源的报文。

###### 查询器的选举：<font color = black>IP地址最小的获胜。</font>

##### IGMPv1

==IGMPv1没有成员查询机制，它借助PIM（协议无关组播）来选举DR，只有DR负责发送组播查询报文。==



1. 组播路由器每60s发送一次查询报文，目的地址为224.1.1.0，组地址为0.0.0.0。
2. 组成员在收到查询报文后，开启计时器，计时器被设置为0~10s，在计时器超时后，向查询路由器发送成员关系报告报文，这个报文的目的IP地址是想要加入的组播组的IP地址。
3. 同一个组播组下的所有成员，在收到相同的关系查询报文时，默认只有计时器率先超时的主机会发送成员关系报告报文给关系查询路由器，其他的主机会抑制自己，不发送关系报告报文。
4. IGMPv1下，有成员离开组播组时，不会发送任何报文告知查询器，而是“默默离开”，查询器发送关系查询报文后，等待130s<font color = green>(2*默认关系查询报文发送时间+10s的计时器时间)</font>后，将认为该组播组已经不存在成员，不再发送组播地址为该组的流量。



###### IGMP V1的缺点:

1、组成员没有离组机制，导致路由器需要被动等待130s，才停止组播流量下发。
2、没有查询器选举机制
3、路由器不能控制组成员响应时间。

###### TGMPv2针对1GMPv1做了改进

1. 基本原理和IGMPV1相同。
2. 增加离组报文，当组成员离组时，会主动发送离组报文。离组报文发送目的IP为224.0.0.2，代表网段所有的路由器接口。
3. 增加特定组查询报文，路由器收到离组报文，得知某个组有成员离开，就会发送特定组查询报文，DIP为成员离开的那个组地址。
4. 默认情况下，特定组查询报文每隔1s连续发2次，在1*2的时间内，如果没有收到该组的成员关系报文，则认为这个组己经没有成员。结束该组流量，不再继续向该网段发送，如果收到该组的成员关系报文，则继续下发该的组的组播流量。
   注意:特定组查询报文依然有成员关系抑制机制，抑制时间为1s，也就是在1s内随机等待一个时间，超时后回复报告报文。同组成员收到后，不再发送报告报文。
   管理员可以配置发送特定组查询的间隔以及发送次数，间隔决定成员的响应时间，间隔时间的次数，决定了路由器在多久后没收到报告认为不再有成员。

<img src="C:\Users\yangc\AppData\Roaming\Typora\typora-user-images\image-20220719165335473.png" alt="image-20220719165335473" style="zoom: 80%;" />

结束该组流量，不再继续向该网段发送，如果收到该组的成员关系报文，则继续下发该的组的组播流量。
注意:特定组查询报文依然有成员关系抑制机制，抑制时间为1s，也就是在1s内随机等待一个时间，超时后回复报告报文。同组成员收到后，不再发送报告报文。
管理员可以配置发送特定组查询的间隔以及发送次数，同隔决定成员的响应时间，间隔时间一次数，决定了路由器在多久后没收到报告认为不在有成员。

##### IGMPv2

在IGMPv2中，一共有四种报文。

1. 成员关系查询报文
   * 常规查询：目的IP地址为224.0.0.1，查询的是所有组播组，也叫普遍查询。
   * 特定组查询：IGMPv2的主机在离开所加入的组播组时，会发送一个离组报文来宣告自己离开。当查询器收到这个离组报文后，会发送特定的组的报文，来确认该组中是否还有其他成员存在。
2. 成员关系报告报文
3. 离组报文；在IGMPv1的基础上加入了离组报文，目的IP地址为224.0.0.2.
4. 版本1成员关系报告报文：用于兼容IGMPv1。
4. IGMPv2查询器：IP地址小的当选查询器。



##### #类型值有4种

1. 成员关系查询报文 0x11；
2. v1的成员关系报告报文 0x12;
3. v2的成员关系报告报文 0x16;
4. 离组报文 0x17。

成员关系抑制报告机制：v2和v1有一点细微的差异；IMGPv2增加了最大响应时间，这个值可以调节。取值范围为0~最大响应时间之间。

在IGMPv2中，当有成员离开组播组时，会向查询器发送离组报文，告知自己离开。查询器收到离组报文后，会发送查询报文（特定组播组）来查看组播组中是否还有其他成员存在，如果有成员响应了，则继续维护成员关系，如果没有，查询器会以1s为间隔，发送两次，如果没有了响应，在经过一段时间后，将不再发送该组播组相关的流量。

* **IGMPv2的查询器选举：该网段中IP地址最小的成为查询器，具备抢占机制。非查询器会启动一个==其他查询器存活计时，缺省为125s(健壮系数x普遍组查询时间间隔x（1/2x最大响应时间)==，在125s后接收不到查询器发送的查询报文而导致计时器超时，费查询器就会认为当前查询器已发送故障，出发新一轮的查询器选举。**

​      ==125=2x60+1/2x10==

​     ==**健壮系数**===特定组连续发送的次数 （可以通过命令 igmp robust-count 来指定次数)

<img src="C:\Users\yangc\AppData\Roaming\Typora\typora-user-images\image-20220719173046148.png" alt="image-20220719173046148" style="zoom:80%;" />

##### IGMPv3

1. IGMPv3在v2的基础上主要增加了组播接受者对组播源的过滤功能。
2. IGMPv3服务于SSM模型，同时取消了组成员报告抑制机制。
3. IGMPv3定义了两种报文：成员关系查询报文，成员关系报告报文。
4. 报文中不仅包含普遍组查询报文和特点组查询报文，还新增了特定源组查询报文。
5. IGMPv3没有成员抑制机制。



###### IGMP各个版本间的差异

![image-20220719181045793](C:\Users\yangc\AppData\Roaming\Typora\typora-user-images\image-20220719181045793.png)

==IGMPv1，v2的客户端是针对ASM组播模型开发的协议，ASM比较消耗组播地址资源。

IGMPv3的客户端是针对支持SSM组播模型开发的协议，成员可以对组播源和组播组进行选择，并且支持ASM模型，但实际应用较少，应用客户端维护难度大。

![image-20220719192027137](C:\Users\yangc\AppData\Roaming\Typora\typora-user-images\image-20220719192027137.png)

#### PIM(协议无关组播)

PIM:协议无关组播——有两种模式

* DM(密集模式，Dense Mode)：当接收者分布较为密集时适用；
* SM(稀疏模式, Sparse Mode)：当接收接分布较为稀疏时适用。

##### PIM-DM

PIM-DM：假定每条链路都有接受者。采用“推模式“转发组播报文。

PIM-DM：假定每条链路上都有接收者，所以可以在每条链路上直接推送组播流量。

PIM-DM DR；没有实际用途，作为IGMPv1的查询器，对于DM模式来说，DR没有任何额外的用途。

PIM-DM使用的组播分法树是SPT。

接口激活PIM后，会周期性的发送PIM Hello报文，缺省时间30s。

==如果PIM HelLo报文发现了PIM邻居，会为该邻居启动一个计时器，缺省105s，在计时器超时前再次收到该邻居发送的Hello报文，则刷新计时器，否则将会立即删除该邻居。

当某个组播路由器下边没有接入关于指定组播源和目的IP地址时，会向上游发送一个剪枝报文，将自己从SPT上剪除。剪枝报文会周期性发送，来刷新自己的剪除状态。（刷新状态机制优化了这个需要周期性发送剪枝报文的过程）。

###### 嫁接过程

组播路由器在需要组播流量时，可以主动将自己嫁接到SPT中。

嫁接报文是一个单播报文，源地址是发送该嫁接报文的接口的IP地址，目的IP为上游接口的IP地址。

嫁接报文发送后，发送者（路由器）的上游接口会启动一个嫁接计时器（3s），计时器超时后依然没有收到上游邻居发回的PIM嫁接确认报文，则会继续发送嫁接报文。

收到下游发上来的嫁接报文后，原本处于剪枝状态的接口会切换到转发状态。

###### 断言机制（Assert）

1. 当同一个组播网络出现有路由器发送相同的组播流量时，会触发断言机制，断言机制是选举制：
2. 选举规则：
   * 比较双方到达组播源的单播地址的路由优先级，最小的胜出。
   * 比较双方到达组播源的单播地址的路由度量值，最小的胜出。
   * 比较双方接口的IP地址，IP地址较大的胜出。



### PIM-SM

一个RP可以同时为多个组播组服务。

RP类似于一个RPT的汇聚点。

PIM-SM模型中选举DR。

DR选举规则：

1. 优先级最高的设备（接口）成为DR，优先级值越大，优先级越高
2. 优先级相同，接口IP大的成为DR。
3. DR的角色具备抢占性，但网络中出现新的设备，并且优先级比原来的DR还大，并会抢占DR。

##### IGMP Snooping（IGMP 监听机制）

###### 基本术语

1. 路由器接口：运行了IGMP Snooping 的交换机==朝向上游组播路由器的接口==。可以手动指定接口也可以通过动态的方式自动发现。交换机会将其收到IGMP常规查询报文或者PIM Hello报文的接口视为动态路由器接口。
2. 成员接口：交换机朝向组播组成员的接口。
3. 二层组播转发表：

运行了IGMP Snooping的交换机收到IGMP成员报告关系报文后，会将该报文从所有路由器接口转发出去，但是不会将该报文从成员接口转发出去。

==IGMP snooping 代理==

IGMP Snooping代理有两个功能：

（1） 代替上游IGMP查询器，自己生成IGMP查询报文并向下游的成员进行查询；

 （2）代替下游组成员，自己生成IGMP成员关系报告报文或离组报文并发送给上游组播路由器。



1. 交换机在路由器端口上收到普通组查询报文，向其他所有接口泛洪。

2. 主机收到查询报文后，回复报告报文，交换机收到报告报文向路由器端口转发，不会泛洪。同时将该端口加入对应的组播转发表中。
   <font size = 6px>为什么报告报文只能从路由器端口转发呢?</font>

   毕意报告报文也是组播报文
   原因要交换机知道某个组所看成员在自身的都些接口上存在，就必须要让该组的所有成员都发送报告，要屏蔽掉查询报文的抑制机制。

   3. 主机离组发送离组报文，交换机收到离组报文后不会立即删除该成员接口，离组报文向路由器端口转发。
   4. 路由器收到离组报文，发送特定组查询报文，交换机向成员端口泛洪。如果该端口在2s内没有收到报告报文，则删除该成员端口。如果收到了成员报告，重置成员端口的老化时间。
   5. 为什么交换机收到离组报文，不会立即删除该成员端口呢?原因是该成员端口下，不一定只有一个成员。

